"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const testcafe_hammerhead_1 = require("testcafe-hammerhead");
const pipeline_context_1 = __importDefault(require("./pipeline-context"));
const event_factory_1 = __importDefault(require("./event-factory"));
const string_1 = require("../utils/string");
const connection_1 = __importDefault(require("../../browser/connection"));
const cdp_1 = require("../utils/cdp");
class ProxylessRequestHookEventProvider extends testcafe_hammerhead_1.RequestHookEventProvider {
    constructor(browserId) {
        super();
        this._pipelineContexts = {};
        this._eventFactories = {};
        this._browserId = browserId;
    }
    _createPipelineContext(requestId) {
        const pipelineContext = new pipeline_context_1.default(requestId);
        this._pipelineContexts[requestId] = pipelineContext;
        return pipelineContext;
    }
    _getSessionId() {
        const browserConnection = connection_1.default.getById(this._browserId);
        const currentTestRun = browserConnection.getCurrentTestRun();
        return (currentTestRun === null || currentTestRun === void 0 ? void 0 : currentTestRun.id) || '';
    }
    _createEventFactory(event) {
        const sessionId = this._getSessionId();
        const eventFactory = new event_factory_1.default(event, sessionId);
        this._eventFactories[event.networkId] = eventFactory;
        return eventFactory;
    }
    getPipelineContext(requestId) {
        return this._pipelineContexts[requestId];
    }
    _getEventFactory(requestId) {
        return this._eventFactories[requestId];
    }
    _getContextData(event) {
        const pipelineContext = this.getPipelineContext(event.networkId);
        const eventFactory = this._getEventFactory(event.networkId);
        return { pipelineContext, eventFactory };
    }
    static _hasResponseWithBody(context) {
        return context.onResponseEventData.some((eventData) => eventData.opts.includeBody);
    }
    static async _setResponseBody({ pipelineContext, resourceBody, eventFactory, event, client }) {
        if ((resourceBody === null || resourceBody === void 0 ? void 0 : resourceBody.length) || (0, cdp_1.isPreflightRequest)(event)) {
            eventFactory.setResponseBody(resourceBody);
            return;
        }
        const hasOnResponseWithBody = ProxylessRequestHookEventProvider._hasResponseWithBody(pipelineContext);
        if (!hasOnResponseWithBody)
            return;
        const responseObj = await client.Fetch.getResponseBody({ requestId: event.requestId });
        const responseBody = (0, string_1.getResponseAsBuffer)(responseObj);
        eventFactory.setResponseBody(responseBody);
    }
    cleanUp(requestId) {
        delete this._pipelineContexts[requestId];
        delete this._eventFactories[requestId];
    }
    async onRequest(event) {
        if (!this.hasRequestEventListeners())
            return;
        const pipelineContext = this._createPipelineContext(event.networkId);
        const eventFactory = this._createEventFactory(event);
        pipelineContext.setRequestOptions(eventFactory);
        await pipelineContext.onRequestHookRequest(this, eventFactory);
    }
    async onResponse(event, resourceBody, client) {
        let modified = false;
        if (!this.hasRequestEventListeners()) {
            this.cleanUp(event.networkId);
            return modified;
        }
        const { pipelineContext, eventFactory } = this._getContextData(event);
        eventFactory.update(event);
        await pipelineContext.onRequestHookConfigureResponse(this, eventFactory);
        if (eventFactory.headersModified)
            modified = true;
        await ProxylessRequestHookEventProvider._setResponseBody({
            pipelineContext,
            resourceBody,
            eventFactory,
            event,
            client,
        });
        await Promise.all(pipelineContext.onResponseEventData.map(async (eventData) => {
            await pipelineContext.onRequestHookResponse(this, eventFactory, eventData.rule, eventData.opts);
        }));
        this.cleanUp(event.networkId);
        return modified;
    }
}
exports.default = ProxylessRequestHookEventProvider;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXZlbnQtcHJvdmlkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvcHJveHlsZXNzL3JlcXVlc3QtaG9va3MvZXZlbnQtcHJvdmlkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSw2REFBb0Y7QUFHcEYsMEVBQTBEO0FBRTFELG9FQUFvRDtBQUVwRCw0Q0FBc0Q7QUFDdEQsMEVBQXlEO0FBQ3pELHNDQUFrRDtBQU9sRCxNQUFxQixpQ0FBa0MsU0FBUSw4Q0FBd0I7SUFLbkYsWUFBYSxTQUFpQjtRQUMxQixLQUFLLEVBQUUsQ0FBQztRQUVSLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxFQUFFLENBQUM7UUFDNUIsSUFBSSxDQUFDLGVBQWUsR0FBSyxFQUFFLENBQUM7UUFDNUIsSUFBSSxDQUFDLFVBQVUsR0FBVSxTQUFTLENBQUM7SUFDdkMsQ0FBQztJQUVPLHNCQUFzQixDQUFFLFNBQWlCO1FBQzdDLE1BQU0sZUFBZSxHQUFHLElBQUksMEJBQXdCLENBQUMsU0FBUyxDQUFDLENBQUM7UUFFaEUsSUFBSSxDQUFDLGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxHQUFHLGVBQWUsQ0FBQztRQUVwRCxPQUFPLGVBQWUsQ0FBQztJQUMzQixDQUFDO0lBRU8sYUFBYTtRQUNqQixNQUFNLGlCQUFpQixHQUFHLG9CQUFpQixDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFzQixDQUFDO1FBQzFGLE1BQU0sY0FBYyxHQUFNLGlCQUFpQixDQUFDLGlCQUFpQixFQUFFLENBQUM7UUFFaEUsT0FBTyxDQUFBLGNBQWMsYUFBZCxjQUFjLHVCQUFkLGNBQWMsQ0FBRSxFQUFFLEtBQUksRUFBRSxDQUFDO0lBQ3BDLENBQUM7SUFFTyxtQkFBbUIsQ0FBRSxLQUF5QjtRQUNsRCxNQUFNLFNBQVMsR0FBTSxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDMUMsTUFBTSxZQUFZLEdBQUcsSUFBSSx1QkFBcUIsQ0FBQyxLQUFL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QUV4QyxPQUFPLFFBQVEsQ0FBQztTQUNuQjtRQUVELE1BQU0sRUFBRSxlQUFlLEVBQUUsWUFBWSxFQUFFLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUV0RSxZQUFZLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRTNCLE1BQU0sZUFBZSxDQUFDLDhCQUE4QixDQUFDLElBQUksRUFBRSxZQUFZLENBQUMsQ0FBQztRQUV6RSxJQUFJLFlBQVksQ0FBQyxlQUFlO1lBQzVCLFFBQVEsR0FBRyxJQUFJLENBQUM7UUFFcEIsTUFBTSxpQ0FBaUMsQ0FBQyxnQkFBZ0IsQ0FBQztZQUNyRCxlQUFlO1lBQ2YsWUFBWTtZQUNaLFlBQVk7WUFDWixLQUFLO1lBQ0wsTUFBTTtTQUNULENBQUMsQ0FBQztRQUVILE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsbUJBQW1CLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBQyxTQUFTLEVBQUMsRUFBRTtZQUN4RSxNQUFNLGVBQWUsQ0FBQyxxQkFBcUIsQ0FBQyxJQUFJLEVBQUUsWUFBWSxFQUFFLFNBQVMsQ0FBQyxJQUFJLEVBQUUsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3BHLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFSixJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxTQUFtQixDQUFDLENBQUM7UUFFeEMsT0FBTyxRQUFRLENBQUM7SUFDcEIsQ0FBQztDQUNKO0FBOUhELG9EQThIQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9uUmVzcG9uc2VFdmVudERhdGEsIFJlcXVlc3RIb29rRXZlbnRQcm92aWRlciB9IGZyb20gJ3Rlc3RjYWZlLWhhbW1lcmhlYWQnO1xuaW1wb3J0IFByb3RvY29sIGZyb20gJ2RldnRvb2xzLXByb3RvY29sJztcbmltcG9ydCBSZXF1ZXN0UGF1c2VkRXZlbnQgPSBQcm90b2NvbC5GZXRjaC5SZXF1ZXN0UGF1c2VkRXZlbnQ7XG5pbXBvcnQgUHJveHlsZXNzUGlwZWxpbmVDb250ZXh0IGZyb20gJy4vcGlwZWxpbmUtY29udGV4dCc7XG5pbXBvcnQgeyBEaWN0aW9uYXJ5IH0gZnJvbSAnLi4vLi4vY29uZmlndXJhdGlvbi9pbnRlcmZhY2VzJztcbmltcG9ydCBQcm94eWxlc3NFdmVudEZhY3RvcnkgZnJvbSAnLi9ldmVudC1mYWN0b3J5JztcbmltcG9ydCB7IFByb3RvY29sQXBpIH0gZnJvbSAnY2hyb21lLXJlbW90ZS1pbnRlcmZhY2UnO1xuaW1wb3J0IHsgZ2V0UmVzcG9uc2VBc0J1ZmZlciB9IGZyb20gJy4uL3V0aWxzL3N0cmluZyc7XG5pbXBvcnQgQnJvd3NlckNvbm5lY3Rpb24gZnJvbSAnLi4vLi4vYnJvd3Nlci9jb25uZWN0aW9uJztcbmltcG9ydCB7IGlzUHJlZmxpZ2h0UmVxdWVzdCB9IGZyb20gJy4uL3V0aWxzL2NkcCc7XG5cbmludGVyZmFjZSBDb250ZXh0RGF0YSB7XG4gICAgcGlwZWxpbmVDb250ZXh0OiBQcm94eWxlc3NQaXBlbGluZUNvbnRleHQ7XG4gICAgZXZlbnRGYWN0b3J5OiBQcm94eWxlc3NFdmVudEZhY3Rvcnk7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFByb3h5bGVzc1JlcXVlc3RIb29rRXZlbnRQcm92aWRlciBleHRlbmRzIFJlcXVlc3RIb29rRXZlbnRQcm92aWRlciB7XG4gICAgcHJpdmF0ZSByZWFkb25seSBfcGlwZWxpbmVDb250ZXh0czogRGljdGlvbmFyeTxQcm94eWxlc3NQaXBlbGluZUNvbnRleHQ+O1xuICAgIHByaXZhdGUgcmVhZG9ubHkgX2V2ZW50RmFjdG9yaWVzOiBEaWN0aW9uYXJ5PFByb3h5bGVzc0V2ZW50RmFjdG9yeT47XG4gICAgcHJpdmF0ZSByZWFkb25seSBfYnJvd3NlcklkOiBzdHJpbmc7XG5cbiAgICBjb25zdHJ1Y3RvciAoYnJvd3NlcklkOiBzdHJpbmcpIHtcbiAgICAgICAgc3VwZXIoKTtcblxuICAgICAgICB0aGlzLl9waXBlbGluZUNvbnRleHRzID0ge307XG4gICAgICAgIHRoaXMuX2V2ZW50RmFjdG9yaWVzICAgPSB7fTtcbiAgICAgICAgdGhpcy5fYnJvd3NlcklkICAgICAgICA9IGJyb3dzZXJJZDtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9jcmVhdGVQaXBlbGluZUNvbnRleHQgKHJlcXVlc3RJZDogc3RyaW5nKTogUHJveHlsZXNzUGlwZWxpbmVDb250ZXh0IHtcbiAgICAgICAgY29uc3QgcGlwZWxpbmVDb250ZXh0ID0gbmV3IFByb3h5bGVzc1BpcGVsaW5lQ29udGV4dChyZXF1ZXN0SWQpO1xuXG4gICAgICAgIHRoaXMuX3BpcGVsaW5lQ29udGV4dHNbcmVxdWVzdElkXSA9IHBpcGVsaW5lQ29udGV4dDtcblxuICAgICAgICByZXR1cm4gcGlwZWxpbmVDb250ZXh0O1xuICAgIH1cblxuICAgIHByaXZhdGUgX2dldFNlc3Npb25JZCAoKTogc3RyaW5nIHtcbiAgICAgICAgY29uc3QgYnJvd3NlckNvbm5lY3Rpb24gPSBCcm93c2VyQ29ubmVjdGlvbi5nZXRCeUlkKHRoaXMuX2Jyb3dzZXJJZCkgYXMgQnJvd3NlckNvbm5lY3Rpb247XG4gICAgICAgIGNvbnN0IGN1cnJlbnRUZXN0UnVuICAgID0gYnJvd3NlckNvbm5lY3Rpb24uZ2V0Q3VycmVudFRlc3RSdW4oKTtcblxuICAgICAgICByZXR1cm4gY3VycmVudFRlc3RSdW4/LmlkIHx8ICcnO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2NyZWF0ZUV2ZW50RmFjdG9yeSAoZXZlbnQ6IFJlcXVlc3RQYXVzZWRFdmVudCk6IFByb3h5bGVzc0V2ZW50RmFjdG9yeSB7XG4gICAgICAgIGNvbnN0IHNlc3Npb25JZCAgICA9IHRoaXMuX2dldFNlc3Npb25JZCgpO1xuICAgICAgICBjb25zdCBldmVudEZhY3RvcnkgPSBuZXcgUHJveHlsZXNzRXZlbnRGYWN0b3J5KGV2ZW50LCBzZXNzaW9uSWQpO1xuXG4gICAgICAgIHRoaXMuX2V2ZW50RmFjdG9yaWVzW2V2ZW50Lm5ldHdvcmtJZCBhcyBzdHJpbmddID0gZXZlbnRGYWN0b3J5O1xuXG4gICAgICAgIHJldHVybiBldmVudEZhY3Rvcnk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldFBpcGVsaW5lQ29udGV4dCAocmVxdWVzdElkOiBzdHJpbmcpOiBQcm94eWxlc3NQaXBlbGluZUNvbnRleHQge1xuICAgICAgICByZXR1cm4gdGhpcy5fcGlwZWxpbmVDb250ZXh0c1tyZXF1ZXN0SWRdO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2dldEV2ZW50RmFjdG9yeSAocmVxdWVzdElkOiBzdHJpbmcpOiBQcm94eWxlc3NFdmVudEZhY3Rvcnkge1xuICAgICAgICByZXR1cm4gdGhpcy5fZXZlbnRGYWN0b3JpZXNbcmVxdWVzdElkXTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9nZXRDb250ZXh0RGF0YSAoZXZlbnQ6IFJlcXVlc3RQYXVzZWRFdmVudCk6IENvbnRleHREYXRhIHtcbiAgICAgICAgY29uc3QgcGlwZWxpbmVDb250ZXh0ID0gdGhpcy5nZXRQaXBlbGluZUNvbnRleHQoZXZlbnQubmV0d29ya0lkIGFzIHN0cmluZyk7XG4gICAgICAgIGNvbnN0IGV2ZW50RmFjdG9yeSAgICA9IHRoaXMuX2dldEV2ZW50RmFjdG9yeShldmVudC5uZXR3b3JrSWQgYXMgc3RyaW5nKTtcblxuICAgICAgICByZXR1cm4geyBwaXBlbGluZUNvbnRleHQsIGV2ZW50RmFjdG9yeSB9O1xuICAgIH1cblxuICAgIHByaXZhdGUgc3RhdGljIF9oYXNSZXNwb25zZVdpdGhCb2R5IChjb250ZXh0OiBQcm94eWxlc3NQaXBlbGluZUNvbnRleHQpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIGNvbnRleHQub25SZXNwb25zZUV2ZW50RGF0YS5zb21lKChldmVudERhdGE6IE9uUmVzcG9uc2VFdmVudERhdGEpID0+IGV2ZW50RGF0YS5vcHRzLmluY2x1ZGVCb2R5KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHN0YXRpYyBhc3luYyBfc2V0UmVzcG9uc2VCb2R5ICh7IHBpcGVsaW5lQ29udGV4dCwgcmVzb3VyY2VCb2R5LCBldmVudEZhY3RvcnksIGV2ZW50LCBjbGllbnQgfTogeyBwaXBlbGluZUNvbnRleHQ6IFByb3h5bGVzc1BpcGVsaW5lQ29udGV4dCwgcmVzb3VyY2VCb2R5OiBCdWZmZXIgfCBudWxsLCBldmVudEZhY3Rvcnk6IFByb3h5bGVzc0V2ZW50RmFjdG9yeSwgZXZlbnQ6IFJlcXVlc3RQYXVzZWRFdmVudCwgY2xpZW50OiBQcm90b2NvbEFwaSB9KTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGlmIChyZXNvdXJjZUJvZHk/Lmxlbmd0aCB8fCBpc1ByZWZsaWdodFJlcXVlc3QoZXZlbnQpKSB7XG4gICAgICAgICAgICBldmVudEZhY3Rvcnkuc2V0UmVzcG9uc2VCb2R5KHJlc291cmNlQm9keSBhcyBCdWZmZXIpO1xuXG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuXG4gICAgICAgIGNvbnN0IGhhc09uUmVzcG9uc2VXaXRoQm9keSA9IFByb3h5bGVzc1JlcXVlc3RIb29rRXZlbnRQcm92aWRlci5faGFzUmVzcG9uc2VXaXRoQm9keShwaXBlbGluZUNvbnRleHQpO1xuXG4gICAgICAgIGlmICghaGFzT25SZXNwb25zZVdpdGhCb2R5KVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIGNvbnN0IHJlc3BvbnNlT2JqICA9IGF3YWl0IGNsaWVudC5GZXRjaC5nZXRSZXNwb25zZUJvZHkoeyByZXF1ZXN0SWQ6IGV2ZW50LnJlcXVlc3RJZCB9KTtcbiAgICAgICAgY29uc3QgcmVzcG9uc2VCb2R5ID0gZ2V0UmVzcG9uc2VBc0J1ZmZlcihyZXNwb25zZU9iaik7XG5cbiAgICAgICAgZXZlbnRGYWN0b3J5LnNldFJlc3BvbnNlQm9keShyZXNwb25zZUJvZHkpO1xuICAgIH1cblxuICAgIHB1YmxpYyBjbGVhblVwIChyZXF1ZXN0SWQ6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICBkZWxldGUgdGhpcy5fcGlwZWxpbmVDb250ZXh0c1tyZXF1ZXN0SWRdO1xuICAgICAgICBkZWxldGUgdGhpcy5fZXZlbnRGYWN0b3JpZXNbcmVxdWVzdElkXTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgb25SZXF1ZXN0IChldmVudDogUmVxdWVzdFBhdXNlZEV2ZW50KTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGlmICghdGhpcy5oYXNSZXF1ZXN0RXZlbnRMaXN0ZW5lcnMoKSlcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICBjb25zdCBwaXBlbGluZUNvbnRleHQgPSB0aGlzLl9jcmVhdGVQaXBlbGluZUNvbnRleHQoZXZlbnQubmV0d29ya0lkIGFzIHN0cmluZyk7XG4gICAgICAgIGNvbnN0IGV2ZW50RmFjdG9yeSAgICA9IHRoaXMuX2NyZWF0ZUV2ZW50RmFjdG9yeShldmVudCk7XG5cbiAgICAgICAgcGlwZWxpbmVDb250ZXh0LnNldFJlcXVlc3RPcHRpb25zKGV2ZW50RmFjdG9yeSk7XG5cbiAgICAgICAgYXdhaXQgcGlwZWxpbmVDb250ZXh0Lm9uUmVxdWVzdEhvb2tSZXF1ZXN0KHRoaXMsIGV2ZW50RmFjdG9yeSk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIG9uUmVzcG9uc2UgKGV2ZW50OiBSZXF1ZXN0UGF1c2VkRXZlbnQsIHJlc291cmNlQm9keTogQnVmZmVyIHwgbnVsbCwgY2xpZW50OiBQcm90b2NvbEFwaSk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICBsZXQgbW9kaWZpZWQgPSBmYWxzZTtcblxuICAgICAgICBpZiAoIXRoaXMuaGFzUmVxdWVzdEV2ZW50TGlzdGVuZXJzKCkpIHtcbiAgICAgICAgICAgIHRoaXMuY2xlYW5VcChldmVudC5uZXR3b3JrSWQgYXMgc3RyaW5nKTtcblxuICAgICAgICAgICAgcmV0dXJuIG1vZGlmaWVkO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgeyBwaXBlbGluZUNvbnRleHQsIGV2ZW50RmFjdG9yeSB9ID0gdGhpcy5fZ2V0Q29udGV4dERhdGEoZXZlbnQpO1xuXG4gICAgICAgIGV2ZW50RmFjdG9yeS51cGRhdGUoZXZlbnQpO1xuXG4gICAgICAgIGF3YWl0IHBpcGVsaW5lQ29udGV4dC5vblJlcXVlc3RIb29rQ29uZmlndXJlUmVzcG9uc2UodGhpcywgZXZlbnRGYWN0b3J5KTtcblxuICAgICAgICBpZiAoZXZlbnRGYWN0b3J5LmhlYWRlcnNNb2RpZmllZClcbiAgICAgICAgICAgIG1vZGlmaWVkID0gdHJ1ZTtcblxuICAgICAgICBhd2FpdCBQcm94eWxlc3NSZXF1ZXN0SG9va0V2ZW50UHJvdmlkZXIuX3NldFJlc3BvbnNlQm9keSh7XG4gICAgICAgICAgICBwaXBlbGluZUNvbnRleHQsXG4gICAgICAgICAgICByZXNvdXJjZUJvZHksXG4gICAgICAgICAgICBldmVudEZhY3RvcnksXG4gICAgICAgICAgICBldmVudCxcbiAgICAgICAgICAgIGNsaWVudCxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwocGlwZWxpbmVDb250ZXh0Lm9uUmVzcG9uc2VFdmVudERhdGEubWFwKGFzeW5jIGV2ZW50RGF0YSA9PiB7XG4gICAgICAgICAgICBhd2FpdCBwaXBlbGluZUNvbnRleHQub25SZXF1ZXN0SG9va1Jlc3BvbnNlKHRoaXMsIGV2ZW50RmFjdG9yeSwgZXZlbnREYXRhLnJ1bGUsIGV2ZW50RGF0YS5vcHRzKTtcbiAgICAgICAgfSkpO1xuXG4gICAgICAgIHRoaXMuY2xlYW5VcChldmVudC5uZXR3b3JrSWQgYXMgc3RyaW5nKTtcblxuICAgICAgICByZXR1cm4gbW9kaWZpZWQ7XG4gICAgfVxufVxuIl19