"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const testcafe_hammerhead_1 = require("testcafe-hammerhead");
const lodash_1 = require("lodash");
const string_1 = require("../utils/string");
const http_status_codes_1 = require("http-status-codes");
const headers_1 = require("../utils/headers");
class ProxylessEventFactory extends testcafe_hammerhead_1.BaseRequestHookEventFactory {
    constructor(event, sessionId) {
        super();
        this._event = event;
        this._responseBody = Buffer.alloc(0);
        this._sessionId = sessionId;
        this._modifyResponseFunction = this._createModifyResponseFunctions();
        this.headersModified = false;
    }
    _createModifyResponseFunctions() {
        return {
            setHeader: (name, value) => {
                const header = this._event.responseHeaders.find(h => h.name.toLowerCase() === name.toLowerCase());
                if (!header)
                    this._event.responseHeaders.push({ name, value });
                else
                    header.value = value;
                this.headersModified = true;
            },
            removeHeader: (name) => {
                (0, lodash_1.remove)(this._event.responseHeaders, header => header.name.toLowerCase() === name.toLowerCase());
                this.headersModified = true;
            },
        };
    }
    static _getRequestData(request) {
        if (request.postData)
            return (0, string_1.fromBase64String)(request.postData);
        return Buffer.alloc(0);
    }
    static _getIsAjaxRequest(event) {
        return event.resourceType === 'XHR'
            || event.resourceType === 'Fetch';
    }
    update(event) {
        this._event = event;
    }
    setResponseBody(body) {
        this._responseBody = body;
    }
    createRequestInfo() {
        const { requestId, request } = this._event;
        return new testcafe_hammerhead_1.RequestInfo({
            requestId,
            sessionId: this._sessionId,
            userAgent: testcafe_hammerhead_1.RequestInfo.getUserAgent(request.headers),
            url: request.url,
            method: request.method.toLowerCase(),
            headers: (0, headers_1.lowerCaseHeaderNames)(request.headers),
            body: ProxylessEventFactory._getRequestData(request),
            isAjax: ProxylessEventFactory._getIsAjaxRequest(this._event),
        });
    }
    createRequestOptions() {
        const parsedUrl = new URL(this._event.request.url);
        const requestParams = {
            method: this._event.request.method,
            url: this._event.request.url,
            protocol: parsedUrl.protocol,
            hostname: parsedUrl.hostname,
            host: parsedUrl.host,
            port: parsedUrl.port,
            path: parsedUrl.pathname,
            headers: this._event.request.headers,
            body: ProxylessEventFactory._getRequestData(this._event.request),
            isAjax: ProxylessEventFactory._getIsAjaxRequest(this._event),
        };
        if (parsedUrl.username)
            requestParams.auth = parsedUrl.username + ':' + parsedUrl.password;
        return new testcafe_hammerhead_1.RequestOptions(requestParams);
    }
    createConfigureResponseEvent(rule) {
        return new testcafe_hammerhead_1.ConfigureResponseEvent(rule, this._modifyResponseFunction);
    }
    createResponseInfo() {
        return new testcafe_hammerhead_1.ResponseInfo({
            statusCode: this._event.responseStatusCode || http_status_codes_1.StatusCodes.OK,
            headers: (0, headers_1.convertToOutgoingHttpHeaders)(this._event.responseHeaders),
            body: this._responseBody,
            sessionId: '',
            requestId: this._event.requestId,
            isSameOriginPolicyFailed: false,
        });
    }
}
exports.default = ProxylessEventFactory;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXZlbnQtZmFjdG9yeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9wcm94eWxlc3MvcmVxdWVzdC1ob29rcy9ldmVudC1mYWN0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsNkRBUzZCO0FBQzdCLG1DQUFnQztBQUtoQyw0Q0FBbUQ7QUFDbkQseURBQWdEO0FBQ2hELDhDQUFzRjtBQUd0RixNQUFxQixxQkFBc0IsU0FBUSxpREFBMkI7SUFPMUUsWUFBb0IsS0FBeUIsRUFBRSxTQUFpQjtRQUM1RCxLQUFLLEVBQUUsQ0FBQztRQUVSLElBQUksQ0FBQyxNQUFNLEdBQW9CLEtBQUssQ0FBQztRQUNyQyxJQUFJLENBQUMsYUFBYSxHQUFhLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDL0MsSUFBSSxDQUFDLFVBQVUsR0FBZ0IsU0FBUyxDQUFDO1FBQ3pDLElBQUksQ0FBQyx1QkFBdUIsR0FBRyxJQUFJLENBQUMsOEJBQThCLEVBQUUsQ0FBQztRQUNyRSxJQUFJLENBQUMsZUFBZSxHQUFXLEtBQUssQ0FBQztJQUN6QyxDQUFDO0lBRU8sOEJBQThCO1FBQ2xDLE9BQU87WUFDSCxTQUFTLEVBQUUsQ0FBQyxJQUFZLEVBQUUsS0FBYSxFQUFFLEVBQUU7Z0JBQ3ZDLE1BQU0sTUFBTSxHQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsZUFBaUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxLQUFLLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDO2dCQUVySCxJQUFJLENBQUMsTUFBTTtvQkFDTixJQUFJLENBQUMsTUFBTSxDQUFDLGVBQWlDLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7O29CQUVyRSxNQUFNLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztnQkFFekIsSUFBSSxD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QUFTLENBQUMsUUFBUSxDQUFDO1FBRXZFLE9BQU8sSUFBSSxvQ0FBYyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQzdDLENBQUM7SUFFTSw0QkFBNEIsQ0FBRSxJQUF1QjtRQUN4RCxPQUFPLElBQUksNENBQXNCLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO0lBQzFFLENBQUM7SUFFTSxrQkFBa0I7UUFDckIsT0FBTyxJQUFJLGtDQUFZLENBQUM7WUFDcEIsVUFBVSxFQUFnQixJQUFJLENBQUMsTUFBTSxDQUFDLGtCQUFrQixJQUFJLCtCQUFXLENBQUMsRUFBRTtZQUMxRSxPQUFPLEVBQW1CLElBQUEsc0NBQTRCLEVBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUM7WUFDbkYsSUFBSSxFQUFzQixJQUFJLENBQUMsYUFBYTtZQUM1QyxTQUFTLEVBQWlCLEVBQUU7WUFDNUIsU0FBUyxFQUFpQixJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVM7WUFDL0Msd0JBQXdCLEVBQUUsS0FBSztTQUNsQyxDQUFDLENBQUM7SUFDUCxDQUFDO0NBQ0o7QUE1R0Qsd0NBNEdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgICBCYXNlUmVxdWVzdEhvb2tFdmVudEZhY3RvcnksXG4gICAgQ29uZmlndXJlUmVzcG9uc2VFdmVudCxcbiAgICBNb2RpZnlSZXNwb25zZUZ1bmN0aW9ucyxcbiAgICBSZXF1ZXN0RmlsdGVyUnVsZSxcbiAgICBSZXF1ZXN0SW5mbyxcbiAgICBSZXF1ZXN0T3B0aW9ucyxcbiAgICBSZXF1ZXN0T3B0aW9uc1BhcmFtcyxcbiAgICBSZXNwb25zZUluZm8sXG59IGZyb20gJ3Rlc3RjYWZlLWhhbW1lcmhlYWQnO1xuaW1wb3J0IHsgcmVtb3ZlIH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBQcm90b2NvbCBmcm9tICdkZXZ0b29scy1wcm90b2NvbCc7XG5pbXBvcnQgUmVxdWVzdFBhdXNlZEV2ZW50ID0gUHJvdG9jb2wuRmV0Y2guUmVxdWVzdFBhdXNlZEV2ZW50O1xuaW1wb3J0IFJlcXVlc3QgPSBQcm90b2NvbC5OZXR3b3JrLlJlcXVlc3Q7XG5pbXBvcnQgSGVhZGVyRW50cnkgPSBQcm90b2NvbC5GZXRjaC5IZWFkZXJFbnRyeTtcbmltcG9ydCB7IGZyb21CYXNlNjRTdHJpbmcgfSBmcm9tICcuLi91dGlscy9zdHJpbmcnO1xuaW1wb3J0IHsgU3RhdHVzQ29kZXMgfSBmcm9tICdodHRwLXN0YXR1cy1jb2Rlcyc7XG5pbXBvcnQgeyBjb252ZXJ0VG9PdXRnb2luZ0h0dHBIZWFkZXJzLCBsb3dlckNhc2VIZWFkZXJOYW1lcyB9IGZyb20gJy4uL3V0aWxzL2hlYWRlcnMnO1xuXG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFByb3h5bGVzc0V2ZW50RmFjdG9yeSBleHRlbmRzIEJhc2VSZXF1ZXN0SG9va0V2ZW50RmFjdG9yeSB7XG4gICAgcHJpdmF0ZSBfZXZlbnQ6IFJlcXVlc3RQYXVzZWRFdmVudDtcbiAgICBwcml2YXRlIF9yZXNwb25zZUJvZHk6IEJ1ZmZlcjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9zZXNzaW9uSWQ6IHN0cmluZztcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9tb2RpZnlSZXNwb25zZUZ1bmN0aW9uOiBNb2RpZnlSZXNwb25zZUZ1bmN0aW9ucztcbiAgICBwdWJsaWMgaGVhZGVyc01vZGlmaWVkOiBib29sZWFuO1xuXG4gICAgcHVibGljIGNvbnN0cnVjdG9yIChldmVudDogUmVxdWVzdFBhdXNlZEV2ZW50LCBzZXNzaW9uSWQ6IHN0cmluZykge1xuICAgICAgICBzdXBlcigpO1xuXG4gICAgICAgIHRoaXMuX2V2ZW50ICAgICAgICAgICAgICAgICAgPSBldmVudDtcbiAgICAgICAgdGhpcy5fcmVzcG9uc2VCb2R5ICAgICAgICAgICA9IEJ1ZmZlci5hbGxvYygwKTtcbiAgICAgICAgdGhpcy5fc2Vzc2lvbklkICAgICAgICAgICAgICA9IHNlc3Npb25JZDtcbiAgICAgICAgdGhpcy5fbW9kaWZ5UmVzcG9uc2VGdW5jdGlvbiA9IHRoaXMuX2NyZWF0ZU1vZGlmeVJlc3BvbnNlRnVuY3Rpb25zKCk7XG4gICAgICAgIHRoaXMuaGVhZGVyc01vZGlmaWVkICAgICAgICAgPSBmYWxzZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9jcmVhdGVNb2RpZnlSZXNwb25zZUZ1bmN0aW9ucyAoKTogTW9kaWZ5UmVzcG9uc2VGdW5jdGlvbnMge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgc2V0SGVhZGVyOiAobmFtZTogc3RyaW5nLCB2YWx1ZTogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgaGVhZGVyID0gKHRoaXMuX2V2ZW50LnJlc3BvbnNlSGVhZGVycyBhcyBIZWFkZXJFbnRyeVtdKS5maW5kKGggPT4gaC5uYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5hbWUudG9Mb3dlckNhc2UoKSk7XG5cbiAgICAgICAgICAgICAgICBpZiAoIWhlYWRlcilcbiAgICAgICAgICAgICAgICAgICAgKHRoaXMuX2V2ZW50LnJlc3BvbnNlSGVhZGVycyBhcyBIZWFkZXJFbnRyeVtdKS5wdXNoKHsgbmFtZSwgdmFsdWUgfSk7XG4gICAgICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgICAgICBoZWFkZXIudmFsdWUgPSB2YWx1ZTtcblxuICAgICAgICAgICAgICAgIHRoaXMuaGVhZGVyc01vZGlmaWVkID0gdHJ1ZTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICByZW1vdmVIZWFkZXI6IChuYW1lOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgICAgICByZW1vdmUodGhpcy5fZXZlbnQucmVzcG9uc2VIZWFkZXJzIGFzIEhlYWRlckVudHJ5W10sIGhlYWRlciA9PiBoZWFkZXIubmFtZS50b0xvd2VyQ2FzZSgpID09PSBuYW1lLnRvTG93ZXJDYXNlKCkpO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5oZWFkZXJzTW9kaWZpZWQgPSB0cnVlO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHN0YXRpYyBfZ2V0UmVxdWVzdERhdGEgKHJlcXVlc3Q6IFJlcXVlc3QpOiBCdWZmZXIge1xuICAgICAgICBpZiAocmVxdWVzdC5wb3N0RGF0YSlcbiAgICAgICAgICAgIHJldHVybiBmcm9tQmFzZTY0U3RyaW5nKHJlcXVlc3QucG9zdERhdGEpO1xuXG4gICAgICAgIHJldHVybiBCdWZmZXIuYWxsb2MoMCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgX2dldElzQWpheFJlcXVlc3QgKGV2ZW50OiBSZXF1ZXN0UGF1c2VkRXZlbnQpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIGV2ZW50LnJlc291cmNlVHlwZSA9PT0gJ1hIUidcbiAgICAgICAgICAgIHx8IGV2ZW50LnJlc291cmNlVHlwZSA9PT0gJ0ZldGNoJztcbiAgICB9XG5cbiAgICBwdWJsaWMgdXBkYXRlIChldmVudDogUmVxdWVzdFBhdXNlZEV2ZW50KTogdm9pZCB7XG4gICAgICAgIHRoaXMuX2V2ZW50ID0gZXZlbnQ7XG4gICAgfVxuXG4gICAgcHVibGljIHNldFJlc3BvbnNlQm9keSAoYm9keTogQnVmZmVyKTogdm9pZCB7XG4gICAgICAgIHRoaXMuX3Jlc3BvbnNlQm9keSA9IGJvZHk7XG4gICAgfVxuXG4gICAgcHVibGljIGNyZWF0ZVJlcXVlc3RJbmZvICgpOiBSZXF1ZXN0SW5mbyB7XG4gICAgICAgIGNvbnN0IHsgcmVxdWVzdElkLCByZXF1ZXN0IH0gPSB0aGlzLl9ldmVudDtcblxuICAgICAgICByZXR1cm4gbmV3IFJlcXVlc3RJbmZvKHtcbiAgICAgICAgICAgIHJlcXVlc3RJZCxcbiAgICAgICAgICAgIHNlc3Npb25JZDogdGhpcy5fc2Vzc2lvbklkLFxuICAgICAgICAgICAgdXNlckFnZW50OiBSZXF1ZXN0SW5mby5nZXRVc2VyQWdlbnQocmVxdWVzdC5oZWFkZXJzKSxcbiAgICAgICAgICAgIHVybDogICAgICAgcmVxdWVzdC51cmwsXG4gICAgICAgICAgICBtZXRob2Q6ICAgIHJlcXVlc3QubWV0aG9kLnRvTG93ZXJDYXNlKCksXG4gICAgICAgICAgICBoZWFkZXJzOiAgIGxvd2VyQ2FzZUhlYWRlck5hbWVzKHJlcXVlc3QuaGVhZGVycyksXG4gICAgICAgICAgICBib2R5OiAgICAgIFByb3h5bGVzc0V2ZW50RmFjdG9yeS5fZ2V0UmVxdWVzdERhdGEocmVxdWVzdCksXG4gICAgICAgICAgICBpc0FqYXg6ICAgIFByb3h5bGVzc0V2ZW50RmFjdG9yeS5fZ2V0SXNBamF4UmVxdWVzdCh0aGlzLl9ldmVudCksXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBjcmVhdGVSZXF1ZXN0T3B0aW9ucyAoKTogUmVxdWVzdE9wdGlvbnMge1xuICAgICAgICBjb25zdCBwYXJzZWRVcmwgPSBuZXcgVVJMKHRoaXMuX2V2ZW50LnJlcXVlc3QudXJsKTtcblxuICAgICAgICBjb25zdCByZXF1ZXN0UGFyYW1zOiBSZXF1ZXN0T3B0aW9uc1BhcmFtcyA9IHtcbiAgICAgICAgICAgIG1ldGhvZDogICB0aGlzLl9ldmVudC5yZXF1ZXN0Lm1ldGhvZCxcbiAgICAgICAgICAgIHVybDogICAgICB0aGlzLl9ldmVudC5yZXF1ZXN0LnVybCxcbiAgICAgICAgICAgIHByb3RvY29sOiBwYXJzZWRVcmwucHJvdG9jb2wsXG4gICAgICAgICAgICBob3N0bmFtZTogcGFyc2VkVXJsLmhvc3RuYW1lLFxuICAgICAgICAgICAgaG9zdDogICAgIHBhcnNlZFVybC5ob3N0LFxuICAgICAgICAgICAgcG9ydDogICAgIHBhcnNlZFVybC5wb3J0LFxuICAgICAgICAgICAgcGF0aDogICAgIHBhcnNlZFVybC5wYXRobmFtZSxcbiAgICAgICAgICAgIGhlYWRlcnM6ICB0aGlzLl9ldmVudC5yZXF1ZXN0LmhlYWRlcnMsXG4gICAgICAgICAgICBib2R5OiAgICAgUHJveHlsZXNzRXZlbnRGYWN0b3J5Ll9nZXRSZXF1ZXN0RGF0YSh0aGlzLl9ldmVudC5yZXF1ZXN0KSxcbiAgICAgICAgICAgIGlzQWpheDogICBQcm94eWxlc3NFdmVudEZhY3RvcnkuX2dldElzQWpheFJlcXVlc3QodGhpcy5fZXZlbnQpLFxuICAgICAgICB9O1xuXG4gICAgICAgIGlmIChwYXJzZWRVcmwudXNlcm5hbWUpXG4gICAgICAgICAgICByZXF1ZXN0UGFyYW1zLmF1dGggPSBwYXJzZWRVcmwudXNlcm5hbWUgKyAnOicgKyBwYXJzZWRVcmwucGFzc3dvcmQ7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBSZXF1ZXN0T3B0aW9ucyhyZXF1ZXN0UGFyYW1zKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY3JlYXRlQ29uZmlndXJlUmVzcG9uc2VFdmVudCAocnVsZTogUmVxdWVzdEZpbHRlclJ1bGUpOiBDb25maWd1cmVSZXNwb25zZUV2ZW50IHtcbiAgICAgICAgcmV0dXJuIG5ldyBDb25maWd1cmVSZXNwb25zZUV2ZW50KHJ1bGUsIHRoaXMuX21vZGlmeVJlc3BvbnNlRnVuY3Rpb24pO1xuICAgIH1cblxuICAgIHB1YmxpYyBjcmVhdGVSZXNwb25zZUluZm8gKCk6IFJlc3BvbnNlSW5mbyB7XG4gICAgICAgIHJldHVybiBuZXcgUmVzcG9uc2VJbmZvKHtcbiAgICAgICAgICAgIHN0YXR1c0NvZGU6ICAgICAgICAgICAgICAgdGhpcy5fZXZlbnQucmVzcG9uc2VTdGF0dXNDb2RlIHx8IFN0YXR1c0NvZGVzLk9LLFxuICAgICAgICAgICAgaGVhZGVyczogICAgICAgICAgICAgICAgICBjb252ZXJ0VG9PdXRnb2luZ0h0dHBIZWFkZXJzKHRoaXMuX2V2ZW50LnJlc3BvbnNlSGVhZGVycyksXG4gICAgICAgICAgICBib2R5OiAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3Jlc3BvbnNlQm9keSxcbiAgICAgICAgICAgIHNlc3Npb25JZDogICAgICAgICAgICAgICAgJycsXG4gICAgICAgICAgICByZXF1ZXN0SWQ6ICAgICAgICAgICAgICAgIHRoaXMuX2V2ZW50LnJlcXVlc3RJZCxcbiAgICAgICAgICAgIGlzU2FtZU9yaWdpblBvbGljeUZhaWxlZDogZmFsc2UsXG4gICAgICAgIH0pO1xuICAgIH1cbn1cbiJdfQ==